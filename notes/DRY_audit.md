# DRY audit notes

## Opakované CSRF & flash helpery
- `PostsController`, `MediaController`, `TermsController`, `CommentsController`, `UsersController`, `ThemesController`, `SettingsController`, `MigrationsController`, `NavigationController` i `AdminAuthController` mají vždy stejné metody `token()`, `assertCsrf()` a `flash()` včetně logiky pro `$_SESSION['_flash']` a `$_SESSION['csrf_admin']`. Tyto útržky lze sdílet přes společnou abstrakci pro admin controllery (např. základní třídu nebo trait). 【F:inc/Class/Cms/Http/Admin/PostsController.php†L73-L92】【F:inc/Class/Cms/Http/Admin/MediaController.php†L41-L57】【F:inc/Class/Cms/Http/Admin/TermsController.php†L36-L52】【F:inc/Class/Cms/Http/Admin/CommentsController.php†L31-L47】【F:inc/Class/Cms/Http/Admin/UsersController.php†L26-L40】【F:inc/Class/Cms/Http/Admin/ThemesController.php†L36-L51】【F:inc/Class/Cms/Http/Admin/SettingsController.php†L26-L42】【F:inc/Class/Cms/Http/Admin/MigrationsController.php†L19-L35】【F:inc/Class/Cms/Http/Admin/NavigationController.php†L57-L83】【F:inc/Class/Cms/Http/AdminAuthController.php†L30-L46】
- Stejná logika pro veřejnou část je duplikovaná v `post.php` a `login.php`. Lze zvážit sdílený helper pro front-end CSRF a přesměrování. 【F:post.php†L34-L46】【F:login.php†L29-L46】

## Start session + inicializace View/Auth
- Každý admin controller ručně volá `session_start()` a vytváří `ViewEngine` a `AuthService`. Společný konstruktor/parent by mohl zajistit session i společný `ViewEngine`. 【F:inc/Class/Cms/Http/Admin/PostsController.php†L18-L23】【F:inc/Class/Cms/Http/Admin/MediaController.php†L17-L22】【F:inc/Class/Cms/Http/Admin/TermsController.php†L17-L22】【F:inc/Class/Cms/Http/Admin/CommentsController.php†L15-L20】【F:inc/Class/Cms/Http/Admin/UsersController.php†L13-L18】【F:inc/Class/Cms/Http/Admin/ThemesController.php†L15-L23】【F:inc/Class/Cms/Http/Admin/SettingsController.php†L15-L20】【F:inc/Class/Cms/Http/Admin/MigrationsController.php†L15-L20】【F:inc/Class/Cms/Http/Admin/NavigationController.php†L15-L21】【F:inc/Class/Cms/Http/AdminAuthController.php†L13-L18】

## Shodné sestavení dat pro view
- Téměř všechny admin stránky posílají do view hodnoty `pageTitle`, `nav`, `currentUser`, `flash`, `csrf` a často `pagination`. Lze zavést pomocnou metodu (např. `renderAdmin`) pro sestavení základního pole a práci s flash zprávami. 【F:inc/Class/Cms/Http/Admin/PostsController.php†L148-L184】【F:inc/Class/Cms/Http/Admin/MediaController.php†L66-L108】【F:inc/Class/Cms/Http/Admin/TermsController.php†L56-L102】【F:inc/Class/Cms/Http/Admin/CommentsController.php†L48-L107】【F:inc/Class/Cms/Http/Admin/UsersController.php†L38-L71】【F:inc/Class/Cms/Http/Admin/ThemesController.php†L84-L95】【F:inc/Class/Cms/Http/Admin/SettingsController.php†L59-L89】【F:inc/Class/Cms/Http/Admin/MigrationsController.php†L38-L59】【F:inc/Class/Cms/Http/Admin/NavigationController.php†L184-L216】

## Opakovaná logika pro upload cestu
- `PostsController::basePaths()` i `MediaController::paths()` a front-end `post.php` mají identickou detekci base URL pro uploady. Společný factory/helper by odstranil duplicitu. 【F:inc/Class/Cms/Http/Admin/PostsController.php†L93-L99】【F:inc/Class/Cms/Http/Admin/MediaController.php†L58-L64】【F:post.php†L61-L67】

## Repetitivní redirect patterny
- Většina akcí ukončuje metodu pomocí `header('Location: ...'); exit;`. V kombinaci s flash zprávami by šel vytvořit helper (např. `redirectWithFlash`). Duplicity jsou napříč `PostsController`, `MediaController`, `TermsController`, `CommentsController`, `UsersController`, `ThemesController`, `SettingsController`, `NavigationController`, `MigrationsController` atd. 【F:inc/Class/Cms/Http/Admin/PostsController.php†L170-L172】【F:inc/Class/Cms/Http/Admin/MediaController.php†L148-L156】【F:inc/Class/Cms/Http/Admin/TermsController.php†L111-L138】【F:inc/Class/Cms/Http/Admin/CommentsController.php†L123-L172】【F:inc/Class/Cms/Http/Admin/UsersController.php†L82-L122】【F:inc/Class/Cms/Http/Admin/ThemesController.php†L110-L119】【F:inc/Class/Cms/Http/Admin/SettingsController.php†L104-L132】【F:inc/Class/Cms/Http/Admin/NavigationController.php†L233-L368】【F:inc/Class/Cms/Http/Admin/MigrationsController.php†L61-L89】

## Pagination & filtry
- Téměř shodná skladba proměnných `$filters`, `$page`, `$perPage` a mapování výsledku `paginate()` do pole `pagination` se opakuje ve většině listingů (posts, media, terms, comments, users). Pomohl by společný builder pro filtry + paginator. 【F:inc/Class/Cms/Http/Admin/PostsController.php†L152-L184】【F:inc/Class/Cms/Http/Admin/MediaController.php†L66-L107】【F:inc/Class/Cms/Http/Admin/TermsController.php†L56-L102】【F:inc/Class/Cms/Http/Admin/CommentsController.php†L48-L107】【F:inc/Class/Cms/Http/Admin/UsersController.php†L38-L71】

## Další kandidáti
- V `FrontController` existuje vlastní CSRF public logika (`tokenPublic` / `assertCsrfPublic`) a flash mechanismus (`readFrontFlash` volaný v `single()`), což je podobné patternu jako v admin části – lze sjednotit. 【F:inc/Class/Cms/Http/FrontController.php†L98-L115】
- `NavigationController` obsahuje rozsáhlé metody pro načítání menu/items; některé utility (`collectDescendants`, `flattenTree`) by mohly patřit do samostatné třídy pro práci s navigation tree (využitelné i jinde). 【F:inc/Class/Cms/Http/Admin/NavigationController.php†L96-L215】
- Uživatelé/Posts/Terms při validaci používají `RuntimeException` a `flash` – jednotný validační servis by umožnil znovupoužití pravidel (např. slug uniqueness, email check). 【F:inc/Class/Cms/Http/Admin/TermsController.php†L105-L152】【F:inc/Class/Cms/Http/Admin/UsersController.php†L86-L121】

